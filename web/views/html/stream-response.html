<div id="stream-${prompt_id}">
  <div id="stream-container-${prompt_id}">
    <div class="loading-indicator">
      <div class="loading-text">Loading stream<span class="loading-dots">...</span></div>
    </div>
    <div class="response-content"></div>
  </div>
  <style>
    .loading-indicator {
      padding: var(--spacing-2);
    }

    .loading-text {
      font-family: var(--font-family-mono);
    }

    .loading-dots {
      display: inline-block;
      width: 1rem;
      animation: dots 0.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0% {
        content: '.';
      }

      25% {
        content: '..';
      }

      50% {
        content: '...';
      }

      75% {
        content: '';
      }
    }

    .stream-active .loading-indicator {
      display: none;
    }
  </style>
  <script>
    function setupLoadingAnimation(loadingDots) {
      let dotCount = 0;
      return setInterval(() => {
        dotCount = (dotCount + 1) % 4;
        loadingDots.textContent = '.'.repeat(dotCount);
      }, 250);
    }

    function hideLoadingIndicator(container, animationInterval) {
      container.classList.add('stream-active');
      clearInterval(animationInterval);
    }

    function setupStreamResponse() {
      const promptId = '${prompt_id}';
      const streamUrl = '${stream_url}';
      console.log('Setting up SSE connection for prompt:', promptId);

      const container = document.querySelector('#stream-container-' + promptId);
      const responseContent = container.querySelector('.response-content');
      const loadingDots = container.querySelector('.loading-dots');

      if (!container || !responseContent) {
        console.error('Could not find required containers for prompt:', promptId);
        return;
      }

      const animateDots = setupLoadingAnimation(loadingDots);

      console.log('Creating EventSource connection to:', streamUrl);
      const eventSource = new EventSource(streamUrl + '?prompt_id=' + promptId);

      eventSource.onopen = function (event) {
        console.log('SSE connection opened for prompt:', promptId);
      };

      eventSource.onmessage = function (event) {
        console.log('Received message:', event.data);
        hideLoadingIndicator(container, animateDots);
        responseContent.innerHTML += event.data;
      };

      eventSource.addEventListener('StreamClosing', function (event) {
        console.log('Stream closing for prompt:', promptId);
        hideLoadingIndicator(container, animateDots);
        eventSource.close();
      });

      eventSource.onerror = function (event) {
        console.error('SSE connection error for prompt:', promptId, event);
        hideLoadingIndicator(container, animateDots);
        const loadingText = container.querySelector('.loading-text');
        if (loadingText) {
          loadingText.textContent = 'Error connecting to stream';
        }
        eventSource.close();
      };

      // Cleanup when the container is removed from the DOM
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          mutation.removedNodes.forEach(function (node) {
            if (node.contains(container)) {
              console.log('Response container removed, closing SSE connection');
              hideLoadingIndicator(container, animateDots);
              eventSource.close();
              observer.disconnect();
            }
          });
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    setupStreamResponse();
  </script>
</div>