"""
A provider's test_process_stream_response.py file contains the following standard tests:

- Unstructured content (a poem)
- Structured content (a schema)
- Tool calls

"""

import json
from electric_text.providers.data.content_block import ContentBlockType
from electric_text.providers.data.stream_history import StreamHistory
from electric_text.providers.model_providers.openai.functions.process_stream_response import (
    process_stream_response,
)


def test_unstructured_content():
    history: StreamHistory = StreamHistory()

    chunks: list[str] = [
        "event: response.created",
        'data: {"type":"response.created","response":{"id":"resp_682937793f908191b295cbb9473d126a0b7c9e6958f2b408","object":"response","created_at":1747531641,"status":"in_progress","error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}',
        "",
        "event: response.in_progress",
        'data: {"type":"response.in_progress","response":{"id":"resp_682937793f908191b295cbb9473d126a0b7c9e6958f2b408","object":"response","created_at":1747531641,"status":"in_progress","error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}',
        "",
        "event: response.output_item.added",
        'data: {"type":"response.output_item.added","output_index":0,"item":{"id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","type":"message","status":"in_progress","content":[],"role":"assistant"}}',
        "",
        "event: response.content_part.added",
        'data: {"type":"response.content_part.added","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"gre"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"enness"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" spills"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" from"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" earth"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"  \\n"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"under"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"foot"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":","}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" soft"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" whispers"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" rise"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"—"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"  \\n"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"th"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"under"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" sigh"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":"s"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":","}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" then"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"delta":" breaks"}',
        "",
        "event: response.output_text.done",
        'data: {"type":"response.output_text.done","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"text":"greenness spills from earth  \\nunderfoot, soft whispers rise—  \\nthunder sighs, then breaks"}',
        "",
        "event: response.content_part.done",
        'data: {"type":"response.content_part.done","item_id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"greenness spills from earth  \\nunderfoot, soft whispers rise—  \\nthunder sighs, then breaks"}}',
        "",
        "event: response.output_item.done",
        'data: {"type":"response.output_item.done","output_index":0,"item":{"id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"greenness spills from earth  \\nunderfoot, soft whispers rise—  \\nthunder sighs, then breaks"}],"role":"assistant"}}',
        "",
        "event: response.completed",
        'data: {"type":"response.completed","response":{"id":"resp_682937793f908191b295cbb9473d126a0b7c9e6958f2b408","object":"response","created_at":1747531641,"status":"completed","error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[{"id":"msg_6829377983208191987d1dc688449f7a0b7c9e6958f2b408","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"greenness spills from earth  \\nunderfoot, soft whispers rise—  \\nthunder sighs, then breaks"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":112,"input_tokens_details":{"cached_tokens":0},"output_tokens":22,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":134},"user":null,"metadata":{}}}',
        "",
    ]

    for chunk in chunks:
        history: StreamHistory = process_stream_response(chunk, history)

    first_content_block = history.content_blocks[0]

    assert first_content_block.type == ContentBlockType.TEXT

    expected_text = "greenness spills from earth  \nunderfoot, soft whispers rise—  \nthunder sighs, then breaks"

    assert first_content_block.data.text == expected_text


def test_structured_content():
    history: StreamHistory = StreamHistory()

    chunks: list[str] = [
        "event: response.created",
        'data: {"type":"response.created","response":{"id":"resp_6829668ad3c0819194d398a7cd6b6cdb067180f29c491455","object":"response","created_at":1747543690,"status":"in_progress","error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"json_schema","description":null,"name":"schema_response","schema":{"description":"Model representing the response from the prose-to-schema prompt.","examples":[{"created_json_schema_definition":{"properties":{"name":{"type":"string"},"email":{"format":"email","type":"string"},"age":{"minimum":0,"type":"integer"}},"required":["name","email"],"type":"object"},"response_annotation":"A schema for a user profile with name, email, and age fields"}],"properties":{"response_annotation":{"description":"A brief/concise prose description of what JSON schema was inferred from the user\'s input","title":"Response Annotation","type":"string"},"created_json_schema_definition":{"description":"The created JSON schema object returned by the assistant after careful consideration of the user\'s input. Should be a valid JSON schema object; properties object should always be specified.","properties":{"type":{"type":"string"},"properties":{"type":"object"},"required":{"items":{"type":"string"},"type":"array"},"additionalProperties":{"type":"boolean"}},"required":["type","properties","required","additionalProperties"],"title":"Created Json Schema Definition","type":"object"}},"required":["response_annotation","created_json_schema_definition"],"title":"SchemaResponse","type":"object"},"strict":false}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}',
        "",
        "event: response.in_progress",
        'data: {"type":"response.in_progress","response":{"id":"resp_6829668ad3c0819194d398a7cd6b6cdb067180f29c491455","object":"response","created_at":1747543690,"status":"in_progress","error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"json_schema","description":null,"name":"schema_response","schema":{"description":"Model representing the response from the prose-to-schema prompt.","examples":[{"created_json_schema_definition":{"properties":{"name":{"type":"string"},"email":{"format":"email","type":"string"},"age":{"minimum":0,"type":"integer"}},"required":["name","email"],"type":"object"},"response_annotation":"A schema for a user profile with name, email, and age fields"}],"properties":{"response_annotation":{"description":"A brief/concise prose description of what JSON schema was inferred from the user\'s input","title":"Response Annotation","type":"string"},"created_json_schema_definition":{"description":"The created JSON schema object returned by the assistant after careful consideration of the user\'s input. Should be a valid JSON schema object; properties object should always be specified.","properties":{"type":{"type":"string"},"properties":{"type":"object"},"required":{"items":{"type":"string"},"type":"array"},"additionalProperties":{"type":"boolean"}},"required":["type","properties","required","additionalProperties"],"title":"Created Json Schema Definition","type":"object"}},"required":["response_annotation","created_json_schema_definition"],"title":"SchemaResponse","type":"object"},"strict":false}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}',
        "",
        "event: response.output_item.added",
        'data: {"type":"response.output_item.added","output_index":0,"item":{"id":"msg_6829668b309481918fd772064d30297c067180f29c491455","type":"message","status":"in_progress","content":[],"role":"assistant"}}',
        "",
        "event: response.content_part.added",
        'data: {"type":"response.content_part.added","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":""}}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"{\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"response"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"_annotation"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"This"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" schema"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" defines"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" the"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" attributes"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" of"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" a"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" car"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":","}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" including"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" its"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" weight"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":","}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" cost"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":","}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" and"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" range"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":".\\",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"created"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"_json"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"_schema"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"_definition"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":{\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"type"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"object"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"properties"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":{\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"weight"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":{\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"type"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"number"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"description"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"The"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" weight"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" of"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" the"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" car"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" in"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" pounds"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\"}"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"cost"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":{\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"type"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"number"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"description"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"The"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" cost"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" of"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" the"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" car"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" in"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" dollars"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\"}"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"range"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":{\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"type"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"number"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\",\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"description"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\":\\""}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"The"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" range"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" of"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" the"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" car"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" in"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":" miles"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"\\"}}"}',
        "",
        "event: response.output_text.delta",
        'data: {"type":"response.output_text.delta","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"delta":"}}"}',
        "",
        "event: response.output_text.done",
        'data: {"type":"response.output_text.done","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"text":"{\\"response_annotation\\":\\"This schema defines the attributes of a car, including its weight, cost, and range.\\",\\"created_json_schema_definition\\":{\\"type\\":\\"object\\",\\"properties\\":{\\"weight\\":{\\"type\\":\\"number\\",\\"description\\":\\"The weight of the car in pounds\\"},\\"cost\\":{\\"type\\":\\"number\\",\\"description\\":\\"The cost of the car in dollars\\"},\\"range\\":{\\"type\\":\\"number\\",\\"description\\":\\"The range of the car in miles\\"}}}}"}',
        "",
        "event: response.content_part.done",
        'data: {"type":"response.content_part.done","item_id":"msg_6829668b309481918fd772064d30297c067180f29c491455","output_index":0,"content_index":0,"part":{"type":"output_text","annotations":[],"text":"{\\"response_annotation\\":\\"This schema defines the attributes of a car, including its weight, cost, and range.\\",\\"created_json_schema_definition\\":{\\"type\\":\\"object\\",\\"properties\\":{\\"weight\\":{\\"type\\":\\"number\\",\\"description\\":\\"The weight of the car in pounds\\"},\\"cost\\":{\\"type\\":\\"number\\",\\"description\\":\\"The cost of the car in dollars\\"},\\"range\\":{\\"type\\":\\"number\\",\\"description\\":\\"The range of the car in miles\\"}}}}"}}',
        "",
        "event: response.output_item.done",
        'data: {"type":"response.output_item.done","output_index":0,"item":{"id":"msg_6829668b309481918fd772064d30297c067180f29c491455","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"{\\"response_annotation\\":\\"This schema defines the attributes of a car, including its weight, cost, and range.\\",\\"created_json_schema_definition\\":{\\"type\\":\\"object\\",\\"properties\\":{\\"weight\\":{\\"type\\":\\"number\\",\\"description\\":\\"The weight of the car in pounds\\"},\\"cost\\":{\\"type\\":\\"number\\",\\"description\\":\\"The cost of the car in dollars\\"},\\"range\\":{\\"type\\":\\"number\\",\\"description\\":\\"The range of the car in miles\\"}}}}"}],"role":"assistant"}}',
        "",
        "event: response.completed",
        'data: {"type":"response.completed","response":{"id":"resp_6829668ad3c0819194d398a7cd6b6cdb067180f29c491455","object":"response","created_at":1747543690,"status":"completed","error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[{"id":"msg_6829668b309481918fd772064d30297c067180f29c491455","type":"message","status":"completed","content":[{"type":"output_text","annotations":[],"text":"{\\"response_annotation\\":\\"This schema defines the attributes of a car, including its weight, cost, and range.\\",\\"created_json_schema_definition\\":{\\"type\\":\\"object\\",\\"properties\\":{\\"weight\\":{\\"type\\":\\"number\\",\\"description\\":\\"The weight of the car in pounds\\"},\\"cost\\":{\\"type\\":\\"number\\",\\"description\\":\\"The cost of the car in dollars\\"},\\"range\\":{\\"type\\":\\"number\\",\\"description\\":\\"The range of the car in miles\\"}}}}"}],"role":"assistant"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"json_schema","description":null,"name":"schema_response","schema":{"description":"Model representing the response from the prose-to-schema prompt.","examples":[{"created_json_schema_definition":{"properties":{"name":{"type":"string"},"email":{"format":"email","type":"string"},"age":{"minimum":0,"type":"integer"}},"required":["name","email"],"type":"object"},"response_annotation":"A schema for a user profile with name, email, and age fields"}],"properties":{"response_annotation":{"description":"A brief/concise prose description of what JSON schema was inferred from the user\'s input","title":"Response Annotation","type":"string"},"created_json_schema_definition":{"description":"The created JSON schema object returned by the assistant after careful consideration of the user\'s input. Should be a valid JSON schema object; properties object should always be specified.","properties":{"type":{"type":"string"},"properties":{"type":"object"},"required":{"items":{"type":"string"},"type":"array"},"additionalProperties":{"type":"boolean"}},"required":["type","properties","required","additionalProperties"],"title":"Created Json Schema Definition","type":"object"}},"required":["response_annotation","created_json_schema_definition"],"title":"SchemaResponse","type":"object"},"strict":false}},"tool_choice":"auto","tools":[],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":516,"input_tokens_details":{"cached_tokens":0},"output_tokens":85,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":601},"user":null,"metadata":{}}}',
        "",
    ]

    for chunk in chunks:
        history: StreamHistory = process_stream_response(chunk, history)

    first_content_block = history.content_blocks[0]

    assert first_content_block.type == ContentBlockType.TEXT

    raw_text = first_content_block.data.text

    loaded_text = json.loads(raw_text)

    annotation = "This schema defines the attributes of a car, including its weight, cost, and range."

    assert loaded_text["response_annotation"] == annotation

    loaded_json_schema = loaded_text["created_json_schema_definition"]

    properties = loaded_json_schema["properties"]

    assert properties["weight"]["type"] == "number"
    assert properties["weight"]["description"] == "The weight of the car in pounds"

    assert properties["cost"]["type"] == "number"
    assert properties["cost"]["description"] == "The cost of the car in dollars"

    assert properties["range"]["type"] == "number"
    assert properties["range"]["description"] == "The range of the car in miles"


def test_tool_calls():
    history: StreamHistory = StreamHistory()

    chunks: list[str] = [
        "event: response.created",
        'data: {"type":"response.created","sequence_number":0,"response":{"id":"resp_6830e39d617c81918485ea84f37b566a093d752c9f4db954","object":"response","created_at":1748034461,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get the current weather in a given location","name":"get_current_weather","parameters":{"type":"object","properties":{"location":{"type":"string","description":"The city and state, e.g. Omaha, NE"},"unit":{"type":"string","enum":["celsius","fahrenheit"]}},"required":["location"]},"strict":true},{"type":"function","description":"Get the forecast for a given location","name":"get_forecast","parameters":{"type":"object","properties":{"location":{"type":"string","description":"The city and state, e.g. Omaha, NE"},"days":{"type":"integer","description":"The number of days to forecast","minimum":1,"maximum":7}}},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}',
        "",
        "event: response.in_progress",
        'data: {"type":"response.in_progress","sequence_number":1,"response":{"id":"resp_6830e39d617c81918485ea84f37b566a093d752c9f4db954","object":"response","created_at":1748034461,"status":"in_progress","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"auto","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get the current weather in a given location","name":"get_current_weather","parameters":{"type":"object","properties":{"location":{"type":"string","description":"The city and state, e.g. Omaha, NE"},"unit":{"type":"string","enum":["celsius","fahrenheit"]}},"required":["location"]},"strict":true},{"type":"function","description":"Get the forecast for a given location","name":"get_forecast","parameters":{"type":"object","properties":{"location":{"type":"string","description":"The city and state, e.g. Omaha, NE"},"days":{"type":"integer","description":"The number of days to forecast","minimum":1,"maximum":7}}},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":null,"user":null,"metadata":{}}}',
        "",
        "event: response.output_item.added",
        'data: {"type":"response.output_item.added","sequence_number":2,"output_index":0,"item":{"id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","type":"function_call","status":"in_progress","arguments":"","call_id":"call_oDsjdfRkPUYpFtfwiWgwVDAQ","name":"get_current_weather"}}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":3,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"{\\""}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":4,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"location"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":5,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"\\":\\""}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":6,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"O"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":7,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"ma"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":8,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"ha"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":9,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":","}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":10,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":" NE"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":11,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"\\",\\""}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":12,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"unit"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":13,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"\\":\\""}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":14,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"fahren"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":15,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"heit"}',
        "",
        "event: response.function_call_arguments.delta",
        'data: {"type":"response.function_call_arguments.delta","sequence_number":16,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"delta":"\\"}"}',
        "",
        "event: response.function_call_arguments.done",
        'data: {"type":"response.function_call_arguments.done","sequence_number":17,"item_id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","output_index":0,"arguments":"{\\"location\\":\\"Omaha, NE\\",\\"unit\\":\\"fahrenheit\\"}"}',
        "",
        "event: response.output_item.done",
        'data: {"type":"response.output_item.done","sequence_number":18,"output_index":0,"item":{"id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","type":"function_call","status":"completed","arguments":"{\\"location\\":\\"Omaha, NE\\",\\"unit\\":\\"fahrenheit\\"}","call_id":"call_oDsjdfRkPUYpFtfwiWgwVDAQ","name":"get_current_weather"}}',
        "",
        "event: response.completed",
        'data: {"type":"response.completed","sequence_number":19,"response":{"id":"resp_6830e39d617c81918485ea84f37b566a093d752c9f4db954","object":"response","created_at":1748034461,"status":"completed","background":false,"error":null,"incomplete_details":null,"instructions":null,"max_output_tokens":null,"model":"gpt-4o-mini-2024-07-18","output":[{"id":"fc_6830e3a431dc81918ea2dab9fd743c46093d752c9f4db954","type":"function_call","status":"completed","arguments":"{\\"location\\":\\"Omaha, NE\\",\\"unit\\":\\"fahrenheit\\"}","call_id":"call_oDsjdfRkPUYpFtfwiWgwVDAQ","name":"get_current_weather"}],"parallel_tool_calls":true,"previous_response_id":null,"reasoning":{"effort":null,"summary":null},"service_tier":"default","store":true,"temperature":1.0,"text":{"format":{"type":"text"}},"tool_choice":"auto","tools":[{"type":"function","description":"Get the current weather in a given location","name":"get_current_weather","parameters":{"type":"object","properties":{"location":{"type":"string","description":"The city and state, e.g. Omaha, NE"},"unit":{"type":"string","enum":["celsius","fahrenheit"]}},"required":["location"]},"strict":true},{"type":"function","description":"Get the forecast for a given location","name":"get_forecast","parameters":{"type":"object","properties":{"location":{"type":"string","description":"The city and state, e.g. Omaha, NE"},"days":{"type":"integer","description":"The number of days to forecast","minimum":1,"maximum":7}}},"strict":true}],"top_p":1.0,"truncation":"disabled","usage":{"input_tokens":140,"input_tokens_details":{"cached_tokens":0},"output_tokens":25,"output_tokens_details":{"reasoning_tokens":0},"total_tokens":165},"user":null,"metadata":{}}}',
        "",
    ]

    for chunk in chunks:
        history: StreamHistory = process_stream_response(chunk, history)

    first_block = history.content_blocks[0]

    assert first_block.type == ContentBlockType.TOOL_CALL

    assert first_block.data.name == "get_current_weather"

    expected_input_json_string: str = '{"location":"Omaha, NE","unit":"fahrenheit"}'

    actual_input_json_string: str = first_block.data.input_json_string

    assert actual_input_json_string == expected_input_json_string
